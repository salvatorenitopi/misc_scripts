<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">


		<style type="text/css">
			video::-webkit-media-controls-panel {
				background-image: linear-gradient(transparent, transparent) !important;
			}
			body {
				margin: 0px;
			}
			video {
				width: 100%;
			}
			.custom_btn {
				width: 90px;
			}
		</style>

		<title>Trimmer</title>
	</head>

	<body>

		
		<div class="container-fluid">
			<div class="row">


				<div class="col-8" style="padding-top: 10px; padding-bottom: 10px">
					<input id="video_url_input" type="text" class="form-control" value="" placeholder="Video URL"> 
				</div>
				<div class="col-1" style="padding-top: 10px; padding-bottom: 10px">
					<button class="btn btn-secondary custom_btn" type="submit" onClick="load_video()">LOAD</button>
				</div>

				<div class="col-3" style="padding-top: 10px; padding-bottom: 10px">
					<input id="filename_input" type="text" class="form-control" value="" placeholder="filename"> 
				</div>


				<div class="col-6">
					<video id="video" src="" controls="">
				</div>


				<div class="col-6">

					<table border="0">
						<tr>
							<td>
								<input id="time_input" type="text" class="form-control">
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="set_in()">IN</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="set_out()">OUT</button>
							</td>
							<td width="50px">
							</td>
							<td>
								<button class="btn btn-secondary" type="submit" id="go_to_button" onClick="go_to_video(this.value)" value="00:00:00">00:00:00</button>
							</td>
							<td width="20px">
							</td>
							<td>
								<div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
									<input type="checkbox" class="btn-check" id="auto_jump_checkbox" autocomplete="off">
									<label class="btn btn-outline-secondary" for="auto_jump_checkbox">Auto Jump</label>
								</div>
							</td>
						</tr>
					</table>

					<br>

					<table border="0">
						<tr>
							<td>
								<input id="in_input" type="text" class="form-control">
							</td>
							<td>
								<input id="out_input" type="text" class="form-control">
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="append()">OK</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="sort_uniq()">SORT_U</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="build_cmd(true)">CMD</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="build_cmd()">CMD 1L</button>
							</td>
						</tr>
					</table>

					<br>

					<table border="0" style="width: 100%; text-align:center;">
						<tr>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(-1)">-1 sec</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(+1)">+1 sec</button>
							</td>
							<td>
								<div style="width: 20px"></div>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(-5)">-5 sec</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(+5)">+5 sec</button>
							</td>
							<td>
								<div style="width: 20px"></div>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(-10)">-10 sec</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(+10)">+10 sec</button>
							</td>
						</tr>
					</table>

					<br>

					<table border="0" style="width: 100%; text-align:center;">
						<tr>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(-15)">-15 sec</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(+15)">+15 sec</button>
							</td>
							<td>
								<div style="width: 20px"></div>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(-20)">-20 sec</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(+20)">+20 sec</button>
							</td>
							<td>
								<div style="width: 20px"></div>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(-30)">-30 sec</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(+30)">+30 sec</button>
							</td>
						</tr>
					</table>

					<br><br>

					<table border="0" style="width: 100%; text-align:center;">
						<tr>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(-1 * 60)">-1 min</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(+1 * 60)">+1 min</button>
							</td>
							<td>
								<div style="width: 20px"></div>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(-5 * 60)">-5 min</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(+5 * 60)">+5 min</button>
							</td>
							<td>
								<div style="width: 20px"></div>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(-10 * 60)">-10 min</button>
							</td>
							<td>
								<button class="btn btn-secondary custom_btn" type="submit" onClick="seek_video(+10 * 60)">+10 min</button>
							</td>
						</tr>
					</table>

				</div>


				<div class="col-12" style="padding-bottom: 10px">
					<textarea id="time_textarea" class="form-control" aria-label="With textarea" style="height: 80px"></textarea>
				</div>
				<div class="col-12" style="padding-bottom: 10px">
					<textarea id="cmd_textarea" class="form-control" aria-label="With textarea" style="height: 220px"></textarea>
				</div>


				<div class="col-12" style="padding-bottom: 10px">
					find *.mp4 | sed 's:\ :\\\ :g'| sed 's/^/file /' | sort -V > concat.txt; ffmpeg -f concat -i "concat.txt" -c copy output.mp4
				</div>


			</div>
		</div>



		<script type="text/javascript">


			function seek_video(t) {
				var v = document.getElementById("video");
				v.currentTime = v.currentTime + t;
			}


			function go_to_video (time) {
				var v = document.getElementById("video");
				v.currentTime = from_time_to_seconds(time);
			}


			function from_seconds_to_time (sec) {
				sec = Number(sec);

				var h = Math.floor(sec / 3600);
				var m = Math.floor(sec % 3600 / 60);
				var s = Math.floor(sec % 3600 % 60);

				return ('0' + h).slice(-2) + ":" + ('0' + m).slice(-2) + ":" + ('0' + s).slice(-2);
			}


			function form_time_to_seconds (time) {
				try {
					var a = time.split(':');
					var seconds = (+a[0]) * 60 * 60 + (+a[1]) * 60 + (+a[2]);
					return seconds;

				} catch (error) {
					//console.error(error);
					return -1
				}
			}


			function from_time_to_seconds (time) {
				var a = time.split(':'); // split it at the colons
				// minutes are worth 60 seconds. Hours are worth 60 minutes.
				var seconds = (+a[0]) * 60 * 60 + (+a[1]) * 60 + (+a[2]); 
				return seconds;
			}


			// - - - - - - - - - - - - - - - - - - - - - - - - - - - - 


			function load_video () {
				var video_url_input = document.getElementById("video_url_input").value
				
				v = document.getElementById("video");
				v.src = video_url_input;
				v.load();

				var filename = video_url_input.split('/').pop()
				document.getElementById("filename_input").value = filename.slice(0, -4);
			}


			function set_in (){
				var in_value = document.getElementById('time_input').value;
				document.getElementById('in_input').value = in_value;
			}


			function set_out (){
				var out_value = document.getElementById('time_input').value;
				document.getElementById('out_input').value = out_value;
			}


			function append (){
				in_value = document.getElementById('in_input').value;
				out_value = document.getElementById('out_input').value;

				if ((in_value.length < 1) || (out_value.length < 1)) {
					return;
				}

				if (from_time_to_seconds(in_value) > from_time_to_seconds(out_value)) {
					return;
				}
				
				document.getElementById('time_textarea').value += in_value + "-" + out_value + " ";

				document.getElementById('out_input').value = "";
				document.getElementById('in_input').value = "";	//in_value = document.getElementById('in_input').value = "";
			}


			function sort_uniq (){
				blob = document.getElementById('time_textarea').value;
				unsorted = blob.split(" ");
				sorted = unsorted.sort();
				document.getElementById('time_textarea').value = "";
				for (var i in sorted) {
					if (sorted[i].length > 1) {
						if (! document.getElementById('time_textarea').value.includes(sorted[i])) {
							document.getElementById('time_textarea').value += sorted[i] + " ";
						}
					}
				}
			}


			function build_cmd (new_line){
				document.getElementById('cmd_textarea').value = "";

				blob = document.getElementById('time_textarea').value;
				arr = blob.split(" ");

				if ((arr.length < 1) || (blob.length < 1)) {
					return;
				}

				var farr = arr.filter(function (el) {
					return el != "";
				});

				var video_url = document.getElementById("video_url_input").value;
				var filename = document.getElementById("filename_input").value;

				for (var i in farr) {
					var splitted_time = farr[i].split("-");
					var in_time = splitted_time[0];
					var out_time = splitted_time[1];

					out_cmd = 'ffmpeg -ss ' + in_time + ' -to ' + out_time + ' -i "' + video_url + '" -c copy "' + filename + "__" + (Number(i) + 1) + '.mp4"';

					if (! document.getElementById('cmd_textarea').value.includes(out_cmd)) {
						if (new_line == true) {
							document.getElementById('cmd_textarea').value += out_cmd + '\n';
						} else {
							document.getElementById('cmd_textarea').value += out_cmd + '; ';
						}
					}
				}
			}


			// - - - - - - - - - - - - - - - - - - - - - - - - - - - - 



			v = document.getElementById("video");
			v.addEventListener('timeupdate', (event) => {
				document.getElementById("time_input").value = from_seconds_to_time(v.currentTime);
			});



			time_textarea = document.getElementById("time_textarea");
			time_textarea.addEventListener('click', (event) => {
				var cursor = document.getElementById("time_textarea").selectionStart;

				var go_to_button = document.getElementById("go_to_button");
				go_to_button.value = cursor;

				var time_textarea = document.getElementById("time_textarea");
				time_textarea_text = time_textarea.value;

				var in_index = undefined;
				var out_index = undefined;

				for (var i = cursor; i < time_textarea_text.length; i++) {
				 	if (time_textarea_text[i] == " " || time_textarea_text[i] == "-"){
						out_index = i;
						break
					}
				}
				if ((out_index == undefined) && (cursor != time_textarea_text.length) && (cursor + 8 >= time_textarea_text.length)) {
					out_index = time_textarea_text.length;
				}



				for (var i = cursor-1; i >= 0; i--) {
					if (time_textarea_text[i] == " " || time_textarea_text[i] == "-"){
						in_index = i+1;
						break
					}
				}
				if ((in_index == undefined) && (cursor - 8 <= 0)) {
					in_index = 0;
				}


				if ((in_index != undefined) && (out_index != undefined)){
					var sliced = time_textarea_text.slice(in_index, out_index);
					if ((sliced.length == 8) && (form_time_to_seconds(sliced) != -1)){
						go_to_button.innerHTML = sliced;
						go_to_button.value = sliced;

						if (document.getElementById("auto_jump_checkbox").checked == true) {
							go_to_video(sliced);
						}
					}
				}
			});




			time_textarea.addEventListener('keyup', (event) => {
				localStorage.setItem('time_textarea', document.getElementById("time_textarea").value);
			});




			window.onload = function() {
				var last_time_textarea = localStorage.getItem('time_textarea');
				if (last_time_textarea != undefined) {
					document.getElementById("time_textarea").value = last_time_textarea;
				}
			}

			
		</script>



		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

		<!--
		<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
		-->
	</body>
</html>


